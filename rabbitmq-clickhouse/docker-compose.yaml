version: '3.9'
services:
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - 5672:5672
      - 15672:15672

  clickhouse:
    image: yandex/clickhouse-server:latest
    ports:
      - "8123:8123"
      - "9000:9000"
      - "9009:9009"
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8123/ping || exit 1

    ulimits:
      nproc: 65535
      nofile:
        soft: 262144
        hard: 262144

  migrate:
    image: migrate/migrate
    depends_on:
      clickhouse:
        condition: service_healthy
    volumes:
      - ./migrate:/migrations
    command:
      [ "-database",  "clickhouse://clickhouse:9000?username=default&database=default&x-multi-statement=true" ,"-path", "/migrations", "up" ]
